{"version":3,"sources":["../src/datasource.js"],"names":["_","vm","DefaultDatasource","instanceSettings","$q","backendSrv","templateSrv","$http","type","url","name","q","headers","metadata","basicAuth","withCredentials","panel","uri","getMetadata","then","response","dd","hasRawData","rawData","rawDataAlias","sources","dataspecType","getSources","result","namespaces","namespace","method","status","data","error","alias","mapMetrics","metrics","parameters","forEach","parameter","push","value","field","text","options","scopedVars","variables","variable","current","targets","length","query","buildQueryParameters","filter","t","hide","when","doRequest","message","title","undefined","datasourceRequest","target","Object","keys","scopedVarKey","scopedVar"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\nlet vm;\nexport class DefaultDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv, $http) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.headers = {'Content-Type': 'application/json'};\n    this.metadata= {};\n    this.headers['Authorization'] = instanceSettings.basicAuth;\n    this.withCredentials = instanceSettings.withCredentials;\n    this.$http = $http;\n    vm=this;\n\n  }\n\n  updateMetadata(panel, url, uri){\n      this.getMetadata(url, uri).then(function(response){\n          // vm.metadata = response.parameters;\n          if(vm.metadata) {\n              panel.dd = {};\n              panel.dd.hasRawData = vm.metadata.rawData;\n              panel.dd.rawDataAlias = vm.metadata.rawDataAlias;\n          }\n      });\n  }\n\n  getMetrics(){\n    return vm.metadata;\n  }\n\n  loadSources(panel){\n    if(!panel.sources && !panel.dataspecType)\n      this.getSources('timeseries').then(function(result){\n        panel.sources = result;\n      });\n  }\n\n  getAliases(namespaces, namespace){\n    return namespaces[namespace];\n  }\n\n  getMetadata(url, uri) {\n      return vm.$http({\n          url: url + \"/\" + uri + \"/metadata\",\n          method: 'GET',\n      }).then(response => {\n          if (response.status === 200) {\n          return response.data;\n      } }, (error)=> {\n          return null;\n      });\n  }\n\n  metricFindQuery(alias) {\n    return this.getMetadata(alias).then(this.mapMetrics)\n  }\n  \n  mapMetrics(result){\n\n    var metrics =[];\n\n    if(result.parameters) {\n        result.parameters.forEach(function (parameter) {\n            metrics.push({value: parameter.field, text: parameter.name})\n        });\n    }\n    return metrics;\n  }\n\n  getSources(alias){\n      return null;\n  }\n\n  query(options) {\n    if(!options.scopedVars){\n      options.scopedVars = {};\n    }\n\n    if(this.templateSrv.variables) {\n        this.templateSrv.variables.forEach(function (variable) {\n            if (variable.current && variable.current.value) {\n                options.scopedVars[variable.name] = {\n                    text: variable.current.text,\n                    value: variable.current.value\n                }\n            }\n        });\n    }\n\n    if(options.targets.length > 0 && !options.alias) {\n      options.alias = options.targets[0].alias;\n      options.namespace = options.targets[0].namespace;\n    }\n\n    var query = this.buildQueryParameters(options);\n\n    query.targets = query.targets.filter(t => !t.hide);\n    if (!options.alias) {\n      return this.q.when({data: []});\n    }\n\n      return this.doRequest({\n        url: options.namespace + \"/\" + options.alias + '/query',\n        data: query,\n        method: 'POST'\n      });\n  }\n\n  testDatasource() {\n    return this.doRequest({\n      url: this.url + '/api/providers/testRegistration',\n      method: 'GET',\n    }).then(response => {\n      if (response.status === 200) {\n        return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\n      }\n    });\n  }\n\n  getOrganization() {\n      return undefined\n\n  }\n\n  doRequest(options) {\n    options.headers = this.headers;\n    return this.backendSrv.datasourceRequest(options);\n  }\n\n  buildQueryParameters(options) {\n\n    options.parameters = {};\n\n    options.parameters = _.filter(options.targets, target => {\n          return target.field !== 'select metric';\n    });\n\n      if(options.targets.length > 0 && options.targets[0].targets !== undefined)\n      options.parameters = _.filter(options.targets[0].targets, target => {\n        return target.value !== undefined;\n      });\n\n    var targets={};\n    if(options.parameters.length > 0)\n    options.parameters.forEach(function(parameter){\n      targets[parameter.field] = parameter.value;\n    });\n\n    if(options.scopedVars) {\n      Object.keys(options.scopedVars).forEach(function (scopedVarKey) {\n        var scopedVar = options.scopedVars[scopedVarKey];\n        targets[scopedVarKey] = scopedVar.value;\n      });\n    }\n    options.parameters = targets;\n\n    return options;\n  }\n}\n"]}